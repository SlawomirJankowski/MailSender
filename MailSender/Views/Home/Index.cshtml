@model IEnumerable<MailSender.Models.Domains.EmailMessage>

@{
    ViewBag.Title = "[User.Name]'s E-mails";
}


<div class="btn-toolbar justify-content-between">
    <div class="input-group">
        <h1 class="">[User.Name]'s E-mails: </h1>
        <select id="accountSelector" class="form-select text-success form-select-lg mx-3" aria-label=".form-select-lg ">
            <option selected>All accounts</option>
            <option value="1">first@com.com</option>
            <option value="2">second@com.com</option>
        </select>
    </div>

    <div class="input-group">
        <button class="btn btn-info btn-lg"
                onclick='window.location.href="@Url.Action("NewEmail", "Home")"'>
            <i class="fa-solid fa-envelope-open-text"></i>
            New E-mail
        </button>
    </div>
</div>

<hr />

@if (Model != null && Model.Any())
{
    <table id="messagesTable" class=" messagesTable table display table-hover table-striped mt-5 mb-5 text-center align-middle">
        <thead class="table-primary text-center dt-head-center">
            <tr>
                <th scope="col" style="width: 8%">DATE</th>
                <th scope="col" style="width:10%">RECEIVER</th>
                <th scope="col" style="width:20%">SUBJECT</th>
                <th scope="col" style="width:auto">MESSAGE</th>
                <th scope="col" style="width:5%"><i class="fa-solid fa-magnifying-glass"></i></th>
                <th scope="col" style="width:5%"><i class="fa-solid fa-trash-can"></i></th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @foreach (var message in Model)
            {
                <tr>
                    <td>@message.SentDate.ToString()</td>
                    <td>@message.ToEmail</td>
                    <td>@message.Subject</td>

                    @if (string.IsNullOrEmpty(message.Body) ||
                            WebUtility.HtmlDecode(message.Body).Length < 300)
                    {
                        <td class="text-start">@Html.Raw(WebUtility.HtmlDecode(message.Body))</td>
                    }
                    else
                    {
                        <td class="text-start">@Html.Raw(WebUtility.HtmlDecode(message.Body).Substring(0, 300))<span>(...)</span></td>
                    }

                    <td>
                        <button class="btn btn-sm btn-success"
                                onclick='window.location.href="@Url.Action("ViewMessage", "Home", new { id = message.Id })"'>
                            View
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger"
                                onclick="deleteMessage('@message.Id', this)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div>
        <h3>No messages to display</h3>
    </div>
}

@section Scripts
{
    <script type="text/javascript">

        function deleteMessage(id, btn) {

            if (!confirm("Confirm to remove this e-mail?"))
                return;

            $.ajax({
                type: 'POST',
                url: "@Url.Action("Delete", "Home")",
                data: {
                    id: id
                },
                success: function (data) {
                    if (data.Success) {
                        var row = btn.parentNode.parentNode;
                        row.parentNode.removeChild(row);
                    } else {
                        alert(data.Message);
                    }
                },
                error: function (data) {
                    alert(data.Message);
                },
                dataType: 'json'
            });

        }

    </script>
    <script>
        $(document).ready(function () {
            $('.messagesTable').DataTable({
                columnDefs: [
                    {
                        targets: [0, 1, 2, 3, 4],
                        className: 'dt-head-center'
                    },
                    {
                        targets: [3, 4],
                        orderable: false
                    }
                ]
            }
            );
        });
    </script>
}